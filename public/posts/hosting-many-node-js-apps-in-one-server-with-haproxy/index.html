<!DOCTYPE html>
<html lang="en">
<head>

  <!-- Basic Page Needs
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta charset="utf-8">
  <title>Hosting many node js apps in one server with haproxy</title>
  <meta name="description" content="">
  <meta name="author" content="">

  <!-- Mobile Specific Metas
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- FONT
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">

  <!-- CSS
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="stylesheet" href="/css/normalize.css">
  <link rel="stylesheet" href="/css/skeleton.css">
  <link rel="stylesheet" href="/css/app.css">

  <!-- Favicon
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="icon" type="image/png" href="/images/favicon.png">

</head>
<body>

<!-- Primary Page Layout
–––––––––––––––––––––––––––––––––––––––––––––––––– -->

<header class="main-header post-head no-cover">
 <nav class="main-nav">
   <a class="button" href="/">Home</a>
 </nav>


</header>
<div class="container post">
  <div class="row">
    <div class="twelve columns" >
      <h2 class="post-title">Hosting many node js apps in one server with haproxy</h2>
      <h2 id="the-teaser">The Teaser</h2>
<p>HAProxy (short for Hight Availability Proxy) is a proxy solution used for distributing workloads across different nodes (e.g. web servers, databases, clusters). Given that it can make decisions based on content in requests headers, we will be able to direct them depending on domain. </p>
<p>To proxy traffic we will be using Access Control Lists. You can read more about it below, but to give you a “get dirty” example, which is defined in the <code>frontend</code> section of your config file: </p>
<p><code>acl host_cool_app hdr_dom(host) -i coolapp.com</code></p>
<p>This will catch all requests for <code>coolapp.com</code></p>
<p>Then you tell HAproxy which backend to use:</p>
<p><code>use_backend coolapp_cluster if host_cool_app</code></p>
<p>So then your backend will look for something like this:</p>
<pre><code>
backend coolapp_cluster
        server node1 192.168.0.1:9991
</code></pre><p>So, the complete <code>/etc/haproxy/haproxy.cfg</code> for your node.js coolapp will look like this:</p>
<pre><code>
global
        log 127.0.0.1 local0 notice
        daemon
        maxconn 4096
        user haproxy
        group haproxy

defaults
        log global
        mode http
        retries 3
        timeout connect 5000ms
        timeout client 10000ms
        timeout server 10000ms
        stats enable
        stats auth [YOUR_USERNAME:[YOURPASSWORD]
        stats uri /[SOME_PATH]

frontend http-in
        bind [YOUR_PUBLIC_IP]

        acl host_cool_app hdr_dom(host) -i coolapp.com

        use_backend coolapp_cluster if host_cool_app

backend coolapp_cluster
        server node1 192.168.0.1:9991
</code></pre><p>If you want to know more details and how some stuff works with HAproxy, you can continue reading. Please note that this was tested in Linode with ubuntu 12.04 LTS, however you should have no problems implementing this in your own setup.</p>
<h2 id="motivation">Motivation</h2>
<p>Wanted something less monolothic than Appache and didn’t want to deal with its modules. So, I found this as the most interesting alternative, if you want to run different node.js apps at the same time. Plus it gave me oppportunity to learn something new. </p>
<p>By the way, there are other ways to solve this, you can just host it in your favorite webops provider or <a href="http://stackoverflow.com/questions/14259321/apache-node-js-mod-proxy-how-to-route-one-domain-to-3000-and-another-to-8">use apache</a>.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>You will need the following:</p>
<ul>
<li><p>HAProxy: You can follow this <a href="https://www.digitalocean.com/community/articles/how-to-use-haproxy-to-set-up-http-load-balancing-on-an-ubuntu-vps">community guide at Digital Ocean</a> on how to install it.</p>
</li>
<li><p>node.js and there is your <a href="https://github.com/joyent/node/wiki/Installing-Node.js-via-package-manager">node.js install guide from Joynet</a>.</p>
</li>
</ul>
<h2 id="the-configuration">The Configuration</h2>
<p>To make HAProxy proxy routes by domain, we can will use Access Control Lists. From the HAProxy docs: </p>
<blockquote>
<p>ACL provids a flexible solution to perform
content switching and generally to take decisions based on content extracted
from the request…</p>
</blockquote>
<p>The usage is:</p>
<pre><code>acl &lt;aclname&gt; &lt;criterion&gt; [flags] [operator] &lt;value&gt;
</code></pre><p>The <code>criterion</code> we are using for getting the domain name of the headers is <code>hdr_dom</code>, which does the following: </p>
<blockquote>
<p>Returns true when one of the headers contains one of the strings either
  isolated or delimited by dots.</p>
</blockquote>
<h3 id="configuration-file">Configuration file</h3>
<p>Below is the full blown <code>haproxy.cfg</code> file, in case you just want to copy paste. Regarding global and defaults, I will not explain much about them, but you should tweak them based on your needs. You can check what the do and how they can help you in the <a href="http://cbonte.github.io/haproxy-dconv/configuration-1.4.html">HAProxy docs</a>.</p>
<pre><code>
global
        log 127.0.0.1 local0 notice
        daemon
        maxconn 4096
        user haproxy
        group haproxy

defaults
        log global
        mode http
        retries 3
        timeout connect 5000ms
        timeout client 10000ms
        timeout server 10000ms
        stats enable
        stats auth [YOUR_USERNAME:[YOURPASSWORD]
        stats uri /[SOME_PATH]


frontend http-in
        bind [YOUR_PUBLIC_IP]

        acl host_cool_app hdr_dom(host) -i coolapp.com
        acl host_super_app hdr_dom(host) -i superapp.com
        acl host_website hdr_dom(host) -i aboutme.com
        acl host_coolsite hdr_dom(host) -i myname.com

        use_backend coolapp_cluster if host_cool_app
        use_backend superapp_cluster if host_super_app
        use_backend website_cluster if host_website
        use_backend website_cluster if host_coolsite

backend coolapp_cluster
        server node1 192.168.0.1:9991 

backend superapp_cluster
        server node2 192.168.0.1:9992

backend website_cluster
        server node3 192.168.0.1:9993
</code></pre><p>The config of the frontend and backend is what interests us, if your wondering what the user and password stuff is, well it defines if you want HAproxy stats in a web interface with Basic HTTP Authentication.  </p>
<p>Now lets continue with the frontend config. You will need to set <code>bind</code> to your public IP of our server where you will host your apps. Then we will need one <code>acl</code> line per domain as shown below. For example to route the domain <code>coolapp.com</code> to its corresponding node.js app, we will use the following line: </p>
<p><code>acl host_cool_app hdr_dom(host) -i coolapp.com</code></p>
<p>The <code>-i</code> is used to igonre case of this <code>acl</code>. So, this will catch all requests for <code>coolapp.com</code>. Then you want to tell HAproxy which backend to use, and you do it with this line:</p>
<p><code>use_backend coolapp_cluster if host_cool_app</code></p>
<p>So then your backend will look for something like this:</p>
<pre><code>
backend coolapp_cluster
        server node1 192.168.0.1:9991
</code></pre><p>Below you can see a example of how it works if you want to host more than one node.js app. Also, observe that the  <code>acls host_website and host_coolsite</code> are proxied to the  <code>website_cluster</code>. This way can proxy the request of different domains to the same site. E.g. in case you still trying to figure out what to do with your other domains, you can just host a parking page and earn some good stuff via ads ;).</p>
<pre><code>
frontend http-in
        bind [YOUR_PUBLIC_IP]

        acl host_cool_app hdr_dom(host) -i coolapp.com
        acl host_super_app hdr_dom(host) -i superapp.com
        acl host_website hdr_dom(host) -i aboutme.com
        acl host_coolsite hdr_dom(host) -i myname.com

        use_backend coolapp_cluster if host_cool_app
        use_backend superapp_cluster if host_super_app
        use_backend website_cluster if host_website
        use_backend website_cluster if host_coolsite

backend coolapp_cluster
        server node1 192.168.0.1:9991 

backend superapp_cluster
        server node2 192.168.0.1:9992

backend website_cluster
        server node3 192.168.0.1:9993
</code></pre><p>On a final note, there is a big gotcha in the <code>backend</code> configuration that had me scratching my head on why it wasn’t working: you need to use different name for the server. I copied past the config for one backend and just changed the port, but forgot to change the server name from <code>node</code>. So, this is bad:</p>
<pre><code>backend coolapp_cluster
        server node 192.168.0.1:9991 

backend superapp_cluster
        server node 192.168.0.1:9992

backend website_cluster
        server node 192.168.0.1:9993
</code></pre><p>This is good:</p>
<pre><code>backend coolapp_cluster
        server node1 192.168.0.1:9991 

backend superapp_cluster
        server node2 192.168.0.1:9992

backend website_cluster
        server node3 192.168.0.1:9993
</code></pre>
    </div>
  </div>
</div>

<!-- End Document
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
</body>
</html>
